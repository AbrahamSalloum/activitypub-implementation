<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
</head>

<body>

    <details id="show" open>
        <summary>webfinger</summary>
        <table>
            <tr>
                <td>
                    <input id="webfingeruser" type="text" /><button id="fingerbtn">finger</button>
                </td>
            </tr>
            <tr>
                <td>
                    <textarea id="webfingerarea" style="width:500;height:500"></textarea>
                </td>
                <td>
                    <textarea id="actorfilearea" style="width:500;height:500"></textarea>
                </td>
            </tr>
            <tr>
                <td id="msg">

                </td>
            </tr>
        </table>
    </details>

    <details>
        <summary>Post</summary>
        <table>
            <tr>
                <td>
                    <select id="actionselector">
                        <option value="select">select</option>
                        <option value="reply">reply</option>
                    </select>
                    <button id="sendbutton">send</button>
                </td>
            </tr>
            <tr>
                <td>
                    <textarea style="width:1000px;height:1000px"></textarea>
                </td>
            </tr>
            <tr>
                <td id="msg">

                </td>
            </tr>
        </table>
    </details>
    <details>
        <summary>Get Inbox</summary>
        <table>
            <tr>
                <td><button id="getinbox">Get Inbox</button></td>
            </tr>
            <tr>
                <td><textarea id="inboxarea"></textarea></td>
            </tr>
        </table>
    </details>
    <details>
        <summary>Get Followers</summary>
        <table>
            <tr>
                <td><button id="getfollowers">Get Followers</button></td>
                <td>user: <input type="text" id="following_user" placeholder="abraham"></td>
            </tr>
            <tr>
                <td><textarea id="followersarea"></textarea></td>
            </tr>
        </table>
    </details>
    <details>
        <summary>Get FollowING</summary>
        <table>
            <tr>
                <td><button id="getfollowING">Get FollowING</button></td>
                <td>user: <input type="text" id="follows" placeholder="abraham"></td>
            </tr>
            <tr>
                <td><textarea id="followINGsarea"></textarea></td>
            </tr>
        </table>
    </details>
</body>



<script>

    $(document).ready(function () {

        //basedomain = window.location.origin
        webfinger = undefined
        actorfile = undefined

        $('details').hide()
        $('#show').show()

        $('#fingerbtn').on('click', function () {

            user = $('#webfingeruser').val() || 'b@abrajam.com'

            $.ajax({
                type: "GET",
                url: `//${user.split('@')[1]}/.well-known/webfinger?resource=acct:${user}`,
                headers: {"Accept": 'application/ld+json'},
                success: (d) => {
                    webfinger = d
                    $('#webfingerarea').text(JSON.stringify(d, null, 4))
                    userinfo = webfinger['links'].find(item => item.type == "application/activity+json")
                    actorpath = userinfo['href']
                    getActor(actorpath)
                },
                
            });
        })


        function getActor(actorpath) {

            $.ajax({
                type: "GET",
                url: actorpath,
                headers: {"Accept": 'application/ld+json'},
                success: (d) => {
                    actorfile = d
                    $('details').show()
                    $("#actorfilearea").text(JSON.stringify(d, null, 4))
                    
                }
                

            });
        }

        $('#getinbox').on('click', function () {
            $.ajax({
                type: "GET",
                url: "/inspect",
                // data: $('textarea').text(),
                success: (d) => {
                    
                    $('#inboxarea').text(JSON.stringify(d, null, 4))
                },
                contentType: "application/json; charset=utf-8",

            });
        })

        $('select').on('change', function () {
            id = (new Date()).getTime()
            var jsontemplate = {

                "reply": {
                    "@context": "https://www.w3.org/ns/activitystreams",

                    "id": `https://abrajam.com/post-${id}`,
                    "type": "Create",
                    "actor": actorfile.id,

                    "object": {
                        "id": `https://abrajam.com/post-${id}`,
                        "type": "Note",
                        "published": `${id}`,
                        "attributedTo": actorfile.id,
                        "inReplyTo": "https://mastodon.social/@heycitizen/110998990554681845",
                        "content": `<p>Hello world</p> -${id}`,
                        "to": "https://www.w3.org/ns/activitystreams#Public"
                    }
                }

            }



            if (this.value == "reply") {
                console.log(jsontemplate)
                $('textarea').text(JSON.stringify(jsontemplate["reply"], undefined, 4))
            }




        })

        $('#sendbutton').on('click', function () {
            operation = $('#actionselector').value
            data = $('#actionselector').text()
            console.log(data)

            $.ajax({
                type: "POST",
                url: "/post",
                data: $('#actionselector').text(),
                success: (d) => $('#msg').html(d),
                contentType: "application/json; charset=utf-8",
            });

        })

        $('#getfollowers').on('click', function () {

            user = $('#following_user').val() || 'abraham'
            getfollowersbutton = this
            console.log(getfollowersbutton)
            if ($(getfollowersbutton).attr("next")) {
                followersurl = $(getfollowersbutton).attr("next")
            } else {
                followersurl = actorfile.followers 
            }

            $.ajax({
                type: "GET",
                url: followersurl,

                success: function (d) {
                    d.next = "http://google.com"
                    if (d.first) {
                        $.ajax({
                            type: "GET",
                            url: d.first,
                            success: (d) => $('#followersarea').text(JSON.stringify(d, null, 4)),
                            contentType: "application/json; charset=utf-8",

                        });
                    }

                    else if (d.next) {
                        $(getfollowersbutton).attr("next", d.next)
                    }
                },
                contentType: "application/json; charset=utf-8",

            });

        })


        $('#getfollowING').on('click', function () {

            user = $('#follows').val() || 'abraham'
            getfollowersbutton = this
            console.log(getfollowersbutton)
            if ($(getfollowersbutton).attr("next")) {
                followersurl = $(getfollowersbutton).attr("next")
            } else {
                followersurl = actorfile.following 
            }

            $.ajax({
                type: "GET",
                url: followersurl,

                success: function (d) {
                    d.next = "http://google.com"
                    if (d.first) {
                        $.ajax({
                            type: "GET",
                            url: d.first,
                            success: (d) => {
                              
                                $('#followINGsarea').text(JSON.stringify(d, null, 4))
                            },
                            contentType: "application/json; charset=utf-8",

                        });
                    }

                    else if (d.next) {
                        $(getfollowersbutton).attr("next", d.next)
                    }
                },
                contentType: "application/json; charset=utf-8",

            });

        })
    });
</script>

</html>